<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Routine Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Select2 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
        background-color: #f2f2f2;
      }

      .container {
        background-color: #fff;
        padding: 25px;
        border-radius: 10px;
        max-width: 800px;
        margin: auto;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      label {
        font-weight: bold;
        display: block;
        margin-top: 20px;
        margin-bottom: 10px;
      }

      input,
      select,
      button {
        padding: 10px;
        font-size: 16px;
        width: 100%;
        box-sizing: border-box;
      }

      .select2-container {
        width: 100% !important;
      }

      #routineOutput {
        margin-top: 30px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        background-color: white;
      }

      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
      }

      th {
        background-color: #e0e0e0;
      }

      .selected-item {
        background-color: #e6f7ff;
        padding: 8px 12px;
        border: 1px solid #91d5ff;
        border-radius: 4px;
        margin: 5px 0;
      }
      #loadingSpinner {
        display: none;
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>

    <!-- JS Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  </head>
  <body>
    <div class="container">
      <h2>ðŸ“… Routine Generator</h2>

      <label for="fileInput">Upload Routine File (Excel or PDF):</label>
      <input type="file" id="fileInput" accept=".xlsx,.pdf" />

      <label for="courseMultiSelect">Select Courses:</label>
      <select id="courseMultiSelect" multiple></select>

      <button onclick="generateRoutines()">Generate Routines</button>

      <div
        id="loadingSpinner"
        style="display: none; text-align: center; margin-top: 20px"
      >
        <div class="spinner"></div>
        <p>Loading, please wait...</p>
      </div>

      <div id="routineOutput"></div>
      <div id="loadingSpinner"></div>
    </div>

    <script>
      function showSpinner() {
        document.getElementById("loadingSpinner").style.display = "block";
      }
      function hideSpinner() {
        document.getElementById("loadingSpinner").style.display = "none";
      }

      let scheduleData = [];

      document
        .getElementById("fileInput")
        .addEventListener("change", async function (e) {
          const file = e.target.files[0];
          if (!file) return;

          const ext = file.name.split(".").pop().toLowerCase();

          if (ext === "xlsx") {
            handleExcel(file);
          } else if (ext === "pdf") {
            handlePDF(file);
          } else {
            alert("Unsupported file type");
          }
        });

      function removeBrackets(text) {
        return text.replace(/\[.*?\]/g, "").trim();
      }

      function convertTo24Hour(time) {
        const [timePart, modifier] = time.trim().split(/[\s]+/);
        let [hours, minutes] = timePart.split(":").map(Number);
        if (modifier?.toLowerCase() === "pm" && hours < 12) hours += 12;
        if (modifier?.toLowerCase() === "am" && hours === 12) hours = 0;
        return hours + minutes / 60;
      }

      function handleExcel(file) {
        showSpinner();
        const reader = new FileReader();
        reader.onload = function (e) {
          const workbook = XLSX.read(e.target.result, { type: "binary" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet);
          parseRows(json);
          hideSpinner();
        };
        reader.readAsBinaryString(file);
      }

      async function handlePDF(file) {
        showSpinner();
        const reader = new FileReader();
        reader.onload = async function () {
          const typedarray = new Uint8Array(reader.result);
          const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
          let text = "";

          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            const strings = content.items.map((item) => item.str).join(" ");
            text += strings + "\n";
          }

          const lines = text
            .split("\n")
            .filter(
              (line) =>
                line.includes("Section") ||
                line.includes("AM") ||
                line.includes("PM")
            );

          const parsed = lines
            .map((line) => {
              const match = line.match(
                /(.+?)\s+Section\s+(\S+)\s+(\w+)\s+([\d:]+\s*[APMapm]+)\s+to\s+([\d:]+\s*[APMapm]+)/
              );
              if (match) {
                return {
                  "Course Title": match[1],
                  Section: match[2],
                  Day: match[3],
                  "Start Time": match[4],
                  "End Time": match[5],
                };
              }
            })
            .filter(Boolean);

          parseRows(parsed);
          hideSpinner();
        };
        reader.readAsArrayBuffer(file);
      }

      function updateCourseDropdown() {
        const uniqueTitles = [
          ...new Set(scheduleData.map((item) => item.title)),
        ];

        const multiSelect = document.getElementById("courseMultiSelect");
        multiSelect.innerHTML = "";

        uniqueTitles.forEach((title) => {
          const option = document.createElement("option");
          option.value = title;
          option.textContent = title;
          multiSelect.appendChild(option);
        });

        setTimeout(() => {
          $("#courseMultiSelect").select2({
            placeholder: "Search and select courses",
            width: "resolve",
          });
        }, 0);
      }

      function parseRows(rows) {
        const grouped = {};

        rows.forEach((row) => {
          const rawTitle = row["Course Title"] || row["Course Name"] || "";
          const title = removeBrackets(rawTitle);
          const section = row["Section"] || "A";
          const key = `${title}__${section}`;

          const day = row["Day"] || row["Days"] || "";
          const startRaw = row["Start Time"] || row["Starting Time"];
          const endRaw = row["End Time"] || row["Ending Time"];
          const capacity = row["Capacity"] || 0; // New: Assuming the capacity is available in the data

          if (!title || !day || !startRaw || !endRaw) return;

          const session = {
            day,
            startRaw,
            endRaw,
            start: convertTo24Hour(startRaw),
            end: convertTo24Hour(endRaw),
            capacity: capacity,
          };

          if (!grouped[key]) {
            grouped[key] = {
              title,
              section,
              times: [session],
              capacity: capacity, // Store capacity for the section
            };
          } else {
            grouped[key].times.push(session);
          }
        });

        scheduleData = Object.values(grouped);
        updateCourseDropdown();
      }

      // Sort the sections based on capacity when there are conflicts
      function generateRoutines() {
        showSpinner();

        const selectedTitles = Array.from(
          document.getElementById("courseMultiSelect").selectedOptions
        ).map((opt) => opt.value);

        if (selectedTitles.length === 0) {
          alert("Please select at least one course.");
          hideSpinner();
          return;
        }

        const courseGroups = {};
        selectedTitles.forEach((title) => {
          courseGroups[title] = scheduleData.filter(
            (item) => item.title === title
          );
        });

        const courseKeys = Object.keys(courseGroups);
        let validRoutines = [];

        function backtrack(currentRoutine, index) {
          if (index === courseKeys.length) {
            validRoutines.push([...currentRoutine]);
            return;
          }

          const course = courseKeys[index];
          const options = courseGroups[course];

          // Sort options by capacity in descending order
          options.sort((a, b) => b.capacity - a.capacity);

          for (const option of options) {
            if (!conflictsWithRoutine(currentRoutine, option)) {
              currentRoutine.push(option);
              backtrack(currentRoutine, index + 1);
              currentRoutine.pop();
            }
          }
        }

        function conflictsWithRoutine(routine, newItem) {
          for (const item of routine) {
            for (const t1 of item.times) {
              for (const t2 of newItem.times) {
                if (
                  t1.day === t2.day &&
                  t1.start < t2.end &&
                  t1.end > t2.start
                ) {
                  return true;
                }
              }
            }
          }
          return false;
        }

        backtrack([], 0);
        displayRoutines(validRoutines);
        hideSpinner();
      }

      function displayRoutines(routines) {
        const out = document.getElementById("routineOutput");
        out.innerHTML = `<h3>Generated ${routines.length} Valid Routine(s)</h3>`;

        if (routines.length === 0) {
          out.innerHTML += `<p style="color:red;">No possible routines found without time conflicts.</p>`;
          return;
        }

        routines.forEach((routine, idx) => {
          out.innerHTML += `<h4>Routine ${idx + 1}</h4>`;
          out.innerHTML += `<table>
      <tr><th>Course</th><th>Section</th><th>Day</th><th>Time</th></tr>`;
          routine.forEach((item) => {
            item.times.forEach((t) => {
              out.innerHTML += `
          <tr>
            <td>${item.title}</td>
            <td>${item.section}</td>
            <td>${t.day}</td>
            <td>${t.startRaw} - ${t.endRaw}</td>
          </tr>`;
            });
          });
          out.innerHTML += `</table>`;
        });
      }

      // âœ… Initialize Select2 after DOM is loaded
      window.onload = () => {
        $("#courseMultiSelect").select2({
          placeholder: "Search and select courses",
          width: "resolve",
        });
      };
    </script>
  </body>
</html>
